# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Black Don OS is a customized NixOS configuration based on ZaneyOS, designed for multi-host setups with extensive hardware support. This is a flake-based NixOS configuration that manages multiple computers with different hardware profiles.

## Common Development Commands

## Do's and Don'ts
- Don't add unnecessary dependencies
- Don't modify core system files without understanding their purpose
- Don't add code that doesn't serve a purpose for the current task
- Don't add anything extra with out asking first.
- Do use dcli commands when possible

## Gitlab Repository

https://gitlab.com/theblackdon/black-don-os

### Building and Deployment
```bash
# Build configuration for current host
dcli rebuild

# Update flake inputs and rebuild
dcli update

# Build specific host (no activation)
dcli build nix-desktop

# Deploy to specific host
dcli deploy nix-desktop

# Interactive host switcher
dcli switch-host
```

### Testing and Validation
```bash
# Build configuration to test changes (no activation)
nixos-rebuild build --flake .#HOST-NAME

# Show detailed error trace for debugging
nixos-rebuild build --flake .#HOST-NAME --show-trace

# Generate system diagnostic report
dcli diag
```

### Maintenance
```bash
# Clean old generations
dcli cleanup

# List available hosts
dcli list-hosts

# Trim SSD for performance
dcli trim
```

## Architecture Overview

### Multi-Host Configuration System
- **Flake-based**: Uses Nix flakes for reproducible builds and dependency management
- **Host-specific configs**: Each computer has its own directory under `hosts/`
- **Hardware profiles**: GPU-specific configurations in `profiles/` (nvidia, nvidia-laptop, amd, intel, vm)
- **Modular design**: Core system modules, drivers, and home-manager configs are separated

### Key Directories
- `hosts/`: Host-specific configurations (hardware.nix, variables.nix, host-packages.nix)
- `modules/core/`: Core system configuration modules
- `modules/drivers/`: Hardware driver configurations
- `modules/home/`: Home-manager user environment configs
- `profiles/`: Hardware-specific profiles that import appropriate modules

### Configuration Flow
1. `flake.nix` defines hosts and their profiles
2. Profiles import appropriate driver and core modules
3. Host directories contain hardware-specific settings
4. `variables.nix` in each host defines customization options

### Host Configuration Structure
Each host under `hosts/` contains:
- `default.nix`: Imports hardware.nix and host-packages.nix
- `hardware.nix`: Generated by nixos-generate-config, hardware-specific settings
- `variables.nix`: Host-specific variables (monitors, GPU IDs, preferences)
- `host-packages.nix`: Host-specific package installations

## Key Configuration Files

### Host Variables (`hosts/*/variables.nix`)
Important settings to understand when working with host configurations:
- `extraMonitorSettings`: Monitor configuration for Hyprland
- `intelID`/`nvidiaID`: PCI IDs for NVIDIA Prime support
- `browser`, `terminal`: Default applications
- `stylixImage`: Wallpaper for system theming
- `waybarChoice`, `animChoice`: Desktop customization options

### Flake Configuration (`flake.nix`)
- Defines input sources (nixpkgs, home-manager, stylix, etc.)
- Creates host configurations using `mkHost` helper function
- Maps hostnames to hardware profiles
- Includes Flutter development shell for mobile development

## dcli Command Line Tool

Black Don OS includes a custom CLI utility (`dcli`) for system management:

### Essential Commands
- `dcli rebuild`: Rebuild current host
- `dcli update`: Update and rebuild current host
- `dcli build HOST`: Build specific host configuration
- `dcli deploy HOST`: Build and switch to host configuration
- `dcli list-hosts`: Show available hosts
- `dcli cleanup`: Remove old generations

### Shell Aliases
- `fr`: Fast rebuild (`dcli rebuild`)
- `fu`: Fast update (`dcli update`)
- `hosts`: List hosts (`dcli list-hosts`)
- `switch`: Interactive host switcher (`dcli switch-host`)

## Hardware Support

### GPU Profiles
- **nvidia**: Desktop NVIDIA (dedicated GPU)
- **nvidia-laptop**: Laptop NVIDIA + Intel hybrid (Prime support)
- **amd**: AMD Radeon graphics
- **intel**: Intel integrated graphics
- **vm**: Virtual machine optimized

### Adding New Hosts
1. Run `./setup-new-host.sh` to create host template
2. Generate hardware config: `nixos-generate-config --show-hardware-config > ./hosts/NEW-HOST/hardware.nix`
3. Customize `variables.nix` for the new host
4. Update `flake.nix` to include new host configuration
5. Test build: `dcli build NEW-HOST`

## Common Development Tasks

### Modifying System Packages
- System-wide: Edit `modules/core/packages.nix`
- Host-specific: Edit `hosts/HOST/host-packages.nix`

### Desktop Customization
- Wallpapers: Add to `wallpapers/` and reference in `variables.nix`
- Waybar themes: Located in `modules/home/waybar/`
- Hyprland configs: Located in `modules/home/hyprland/`

### Hardware Configuration Updates
- Monitor setup: Update `extraMonitorSettings` in `variables.nix`
- GPU IDs: Use `lspci | grep VGA` to find correct PCI IDs for NVIDIA Prime

## Troubleshooting

### Build Failures
1. Check git status: `dcli status`
2. Generate diagnostic: `dcli diag`
3. Build with trace: `nixos-rebuild build --flake .#HOST --show-trace`
4. Verify host exists: `dcli list-hosts`

### Hardware Detection
- Find GPU IDs: `lspci | grep VGA`
- Monitor detection: `hyprctl monitors`
- Generate new hardware config if needed

### Common Issues
- **Host not found**: Check hostname matches directory in `hosts/`
- **Monitor issues**: Update `extraMonitorSettings` in `variables.nix`
- **Build cache issues**: Run `dcli cleanup` to clear old generations

## Development Workflow

1. Make configuration changes
2. Test build: `dcli build HOST-NAME`
3. If successful, deploy: `dcli deploy HOST-NAME`
4. Commit changes: `dcli commit "description"`
5. Push to repository: `dcli push`

## Repository Structure Notes

- Based on ZaneyOS but customized for multi-host management
- Uses NixOS 25.05 stable with some unstable packages
- Integrates Stylix for system theming
- Home-manager for user environment management
- Flake-utils for development environments (Flutter)
